{% extends "base.html" %}
{% block title %}–ö–æ—Ä–∑–∏–Ω–∞{% endblock %}
{% block content %}
<div class="page-centered scrollable-page">
  <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
  <div id="cart-items"></div>
  <form id="cart-form" class="form-box" style="width:100%;">
    <label>–§–ò–û *</label>
  <input type="text" id="fullname" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>

  <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
  <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" required>

  <label>–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å *</label>
  <input type="text" id="postcode" placeholder="125000" required>

  <button type="submit" class="btn btn-success">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
</form>
</div>
<button class="btn btn-warning" onclick="location.href='/shop'" style="margin-top:20px;">‚Üê –ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω</button>
{% endblock %}

{% block scripts %}
<script>
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => document.body.removeChild(toast), 400);
    }, 3000);
  }

  function loadCart() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const container = document.getElementById('cart-items');

    if (cart.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#aaa;margin:20px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
      return;
    }

    let html = '<h3 style="margin:20px 0 10px;">–¢–æ–≤–∞—Ä—ã:</h3>';
    let total = 0;
    cart.forEach((item, index) => {
      html += `
        <div class="cart-item">
          <span>${item.product}</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <span>${item.price} ü™ô</span>
            <button class="remove-btn" onclick="removeFromCart(${index})">√ó</button>
          </div>
        </div>`;
      total += item.price;
    });
    html += `<div style="text-align:right;margin-top:16px;font-weight:bold;color:#FFD700;">–ò—Ç–æ–≥–æ: ${total} ü™ô</div>`;
    container.innerHTML = html;
  }

  function removeFromCart(index) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCart();
    showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω', 'success');
  }

  document.getElementById('cart-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart.length === 0) return showToast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!', 'error');

    const orderData = {
      fullname: document.getElementById('fullname').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      postcode: document.getElementById('postcode').value.trim(),
      cart: cart
    };

    const res = await fetch('/api/save_cart', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(orderData)
    });
    const result = await res.json();

    if (result.success) {
      localStorage.removeItem('cart');
      showToast(`‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!\n–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${result.new_balance} ü™ô`, 'success');
      setTimeout(() => location.href = '/dashboard', 2000);
    } else {
      showToast('–û—à–∏–±–∫–∞: ' + result.error, 'error');
    }
  });

  loadCart();
</script>
{% endblock %}