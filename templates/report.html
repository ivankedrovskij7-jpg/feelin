{% extends "base.html" %}
{% block title %}–û—Ç—á—ë—Ç{% endblock %}
{% block content %}
<div class="page-centered scrollable-page">
  <h2 style="text-align:center;margin-bottom:20px;">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞</h2>
  <form id="reportForm" class="form-box" style="width:100%;">
  <label>–î–∞—Ç–∞</label>
  <input type="date" id="date" name="date" required>

  <label>–í—Ä–µ–º—è</label>
  <input type="time" id="time" name="time" required>

  <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</label>
  <input type="text" id="name" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ–º ‚Ññ12" required>

  <label>–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞</label>
  <textarea id="address" name="address" placeholder="–≥. –°–∞–º–∞—Ä–∞, —É–ª. –§—Ä—É–Ω–∑–µ..." required></textarea>

  <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</label>
  <textarea id="state" name="state" placeholder="–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>

  <label>–§–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏—è</label>
  <input type="file" id="photos" name="photos" accept="image/*" multiple>
  <div id="preview" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;"></div>

  <button type="submit" class="btn" style="margin-top:20px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç (+100 ü™ô)</button>
</form>
</div>
{% endblock %}

{% block scripts %}
<script>
  let files = [];

  document.getElementById('photos').addEventListener('change', () => {
    const newFiles = Array.from(document.getElementById('photos').files);
    files = [...files, ...newFiles];
    renderPreview();
  });

  function renderPreview() {
    const previewDiv = document.getElementById('preview');
    previewDiv.innerHTML = '';
    files.forEach((f, i) => {
      const container = document.createElement('div');
      container.style.position = 'relative';
      container.style.width = '80px';
      container.style.height = '80px';
      container.style.borderRadius = '8px';
      container.style.overflow = 'hidden';
      container.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
      container.style.background = '#fff';

      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';

      const removeBtn = document.createElement('div');
      removeBtn.textContent = '√ó';
      removeBtn.style.position = 'absolute';
      removeBtn.style.top = '-8px';
      removeBtn.style.right = '-8px';
      removeBtn.style.width = '24px';
      removeBtn.style.height = '24px';
      removeBtn.style.backgroundColor = '#e53e3e';
      removeBtn.style.color = 'white';
      removeBtn.style.borderRadius = '50%';
      removeBtn.style.display = 'flex';
      removeBtn.style.alignItems = 'center';
      removeBtn.style.justifyContent = 'center';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.fontWeight = 'bold';
      removeBtn.style.fontSize = '14px';
      removeBtn.onclick = () => {
        files.splice(i, 1);
        renderPreview();
        updateFileInput();
      };

      container.appendChild(img);
      container.appendChild(removeBtn);
      previewDiv.appendChild(container);
    });
  }

  function updateFileInput() {
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    document.getElementById('photos').files = dt.files;
  }

  function showToast(message, type = 'info', duration = 3000) {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–æ—Å—Ç
    const oldToast = document.querySelector('.toast');
    if (oldToast) oldToast.remove();

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 400);
    }, duration);
  }

  document.getElementById('reportForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    updateFileInput();

    const formData = new FormData(e.target);
    const photos = formData.getAll('photos');

    if (photos.length === 0 || photos.every(f => !f.name)) {
      showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.', 'error');
      return;
    }

    showToast('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info', 10000);

    try {
      const res = await fetch('/api/generate_report', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      const loadingToast = document.querySelector('.toast');
      if (loadingToast) loadingToast.remove();

      if (data.success) {
        showToast('‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!\n+100 ü™ô\n–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ' + data.new_balance, 'success');
        setTimeout(() => location.href = '/dashboard', 2500);
      } else {
        showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'error');
      }
    } catch (err) {
      console.error(err);
      // –°–∫—Ä—ã–≤–∞–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..."
      const loadingToast = document.querySelector('.toast');
      if (loadingToast) loadingToast.remove();
      showToast('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
    }
  });
</script>
{% endblock %}